version: 2.1

jobs:
  test:
    docker:
      - image: cimg/base:stable   # includes Node + ability to install Python + K6
    steps:
      - checkout

      # Install Python
      - run:
          name: Install Python
          command: |
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip

      # Install K6
      - run:
          name: Install K6
          command: |
            sudo apt-get install -y gnupg2 ca-certificates
            curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
            echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
            sudo apt-get update
            sudo apt-get install -y k6

      # Install Lighthouse
      - run:
          name: Install Lighthouse
          command: sudo npm install -g lighthouse

      - run:
          name: Create report folder
          command: mkdir -p test_reports

      # Run K6 test
      - run:
          name: Run K6
          command: k6 run --out json=test_reports/backend_k6.json tests/k6/script.js

      # Run Lighthouse
      - run:
          name: Run Lighthouse
          command: lighthouse http://your-frontend-url.com --output=html --output-path=test_reports/lighthouse_report.html --quiet

      # Upload to FastAPI
      - run:
          name: Upload Reports
          command: |
            python3 - <<EOF
            import requests
            files = {
                "files": open("test_reports/backend_k6.json", "rb"),
                "files2": open("test_reports/lighthouse_report.html", "rb")
            }
            data = {
                "branch": "main",
                "commit": "CI Build",
                "recipients": "your@email.com"
            }
            response = requests.post("https://YOUR-FASTAPI-HOST/analyze", files=files, data=data)
            print(response.text)
            EOF

workflows:
  version: 2
  run-tests:
    jobs:
      - test
