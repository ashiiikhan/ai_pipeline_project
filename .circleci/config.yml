version: 2.1

jobs:
  test:
    docker:
      - image: cimg/base:stable   # Includes Node + ability to install Python + K6
    steps:
      - checkout

      # Install Python
      - run:
          name: Install Python
          command: |
            sudo apt-get update
            sudo apt-get install -y python3 python3-pip

      # Install Python dependencies + K6
      - run:
          name: Install Python dependencies + K6
          command: |
            python3 -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install k6

      # Install Node.js
      - run:
          name: Install Node.js
          command: |
            curl -sL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs

      # Install Lighthouse CLI
      - run:
          name: Install Lighthouse CLI
          command: sudo npm install -g lighthouse

      # Create report folder
      - run:
          name: Create report folder
          command: mkdir -p test_reports

      # Run K6 load test
      - run:
          name: Run K6 Load Test
          command: k6 run --out json=test_reports/backend_k6.json tests/k6/script.js

      # Run Lighthouse test
      - run:
          name: Run Lighthouse Test
          command: |
            while read url; do
              lighthouse $url --output=html --output-path=test_reports/lighthouse_report.html --quiet
            done < tests/lighthouse/urls.txt

      # Upload reports using Python script
      - run:
          name: Upload Reports to AI API
          command: python3 scripts/upload_reports.py

workflows:
  version: 2
  run-tests:
    jobs:
      - test
